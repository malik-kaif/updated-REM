<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Expense Manager (Secure)</title>

<style>
  body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 20px; max-width: 900px; margin-left:auto; margin-right:auto;}
  h1 { color: #0077cc; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 10px; text-align: center; vertical-align: top; }
  input, select { padding: 5px; margin: 5px 0; }
  button { padding: 8px 16px; border: none; background-color: #0077cc; color: white; cursor: pointer; border-radius: 5px; transition: all 0.3s ease; }
  button:hover { background-color: #005fa3; transform: scale(1.05); }
  .add-expense { font-size: 1.1rem; padding: 10px 22px; font-weight: bold; }
  .summary { margin-top: 30px; background: #eaf3fc; padding: 15px; border-radius: 8px; }
  #changeLog { margin-top: 30px; background: #fff4e5; padding: 15px; border-radius: 8px; border: 1px solid #ffc107; max-height: 220px; overflow-y: auto; }
  #changeLog h3 { margin-top: 0; color: #cc8400; }
  .log-entry { font-size: 0.9rem; padding: 3px 5px; border-bottom: 1px solid #ffd966; text-align: left; }
  #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f6ff; }
  #loginBox { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  #appContent { display: none; } /* hidden until password is correct */
</style>
</head>

<body>

<!-- üîí Login Screen -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>üîê Enter Website Password</h2>
    <input type="password" id="sitePassword" placeholder="Enter Password" />
    <br/>
    <button id="loginBtn">Login</button>
    <p id="loginError" style="color:red; display:none;">‚ùå nikal ja bhosdi ke!</p>
  </div>
</div>

<!-- üåê Main App -->
<div id="appContent">
<h1>Room Expense Manager</h1>

<p style="font-weight:bold; color:#0077cc;">üü¢ Active Users: <span id="activeUsers">0</span></p>
<div id="userList"></div>

<h3>Add Expense</h3>
<form id="expenseForm">
  <label for="payer">Payer:</label>
  <select id="payer" name="payer" required>
    <option value="">--Select Student--</option>
    <option value="Kaif">Kaif</option>
    <option value="Surkhab">Surkhab</option>
    <option value="Faizan">Faizan</option>
    <option value="Furqan">Furqan</option>
  </select><br/>
  
  <label for="description">Description:</label>
  <input type="text" id="description" name="description" required placeholder="Expense description" /><br/>
  
  <label for="amount">Amount (‚Çπ):</label>
  <input type="number" id="amount" name="amount" min="0.01" step="0.01" required placeholder="Amount spent" /><br/>
  
  <button type="submit" class="add-expense">‚ûï Add Expense</button>
</form>

<h3>Expenses List</h3>
<table id="expenseTable">
  <thead>
    <tr>
      <th>Payer</th>
      <th>Description</th>
      <th>Amount (‚Çπ)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="summary">
  <h3>Summary</h3>
  <div id="summaryContent"></div>
</div>

<div id="changeLog">
  <h3>Change Log 
    <button id="clearLogBtn" style="float:right; background:#d9534f;">üßπ Clear Log</button>
  </h3>
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Student</th>
        <th>Change History</th>
      </tr>
    </thead>
    <tbody id="logEntries">
      <tr><td colspan="2" style="text-align:center; color:#777;">No changes yet.</td></tr>
    </tbody>
  </table>
</div>
</div> <!-- End of app content -->

<script type="module">
  // üîí Site password setup
  const correctPassword = "12340"; // Change this anytime
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  loginBtn.addEventListener('click', () => {
    const input = document.getElementById('sitePassword').value;
    if (input === correctPassword) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
    } else {
      loginError.style.display = 'block';
    }
  });

  // ‚úÖ Firebase Integration
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved,
    onValue, push, set, update, remove, onDisconnect 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgGr0ZaYNCXnl-XQ-rsARjPoE7f_Px15g",
    authDomain: "updated-rem.firebaseapp.com",
    databaseURL: "https://updated-rem-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "updated-rem",
    storageBucket: "updated-rem.appspot.com",
    messagingSenderId: "231656121503",
    appId: "1:231656121503:web:d06e31fea1233f74802eaa"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const adminPassword = "4321"; // Separate admin password for Clear Log & user removal

  const expenseForm = document.getElementById('expenseForm');
  const expenseTableBody = document.querySelector('#expenseTable tbody');
  const summaryContent = document.getElementById('summaryContent');
  const logEntries = document.getElementById('logEntries');
  const clearLogBtn = document.getElementById('clearLogBtn');

  const expensesRef = ref(database, 'expenses');
  const changeLogRef = ref(database, 'changeLog');
  const connectionsRef = ref(database, 'connections');
  const connectedRef = ref(database, '.info/connected');

  const students = ['Kaif', 'Surkhab', 'Faizan', 'Furqan'];
  let expenses = {}, changeLog = [];

  // ‚úÖ Presence Tracking
  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {
      const con = push(connectionsRef);
      set(con, { connectedAt: new Date().toISOString() });
      onDisconnect(con).remove();
    }
  });

  // ‚úÖ Active Users List
  onValue(connectionsRef, (snapshot) => {
    const data = snapshot.val();
    const count = data ? Object.keys(data).length : 0;
    document.getElementById('activeUsers').textContent = count;

    const userListDiv = document.getElementById('userList');
    if (!data) {
      userListDiv.innerHTML = '<em>No active users.</em>';
      return;
    }

    let html = `<h3>Active Users List</h3>
      <table border="1" width="100%" style="border-collapse:collapse;">
      <tr><th>User ID</th><th>Connected At</th><th>Action</th></tr>`;
    for (let key in data) {
      html += `
        <tr>
          <td>${key}</td>
          <td>${new Date(data[key].connectedAt).toLocaleString()}</td>
          <td><button onclick="removeUser('${key}')">Remove</button></td>
        </tr>`;
    }
    html += '</table>';
    userListDiv.innerHTML = html;
  });

  // ‚úÖ Remove User (Admin Only)
  window.removeUser = async function(id) {
    const pass = prompt("Enter admin password to remove user:");
    if (pass !== adminPassword) return alert("‚ùå Wrong password!");
    await remove(ref(database, 'connections/' + id));
    alert("‚úÖ User removed!");
  };

  // ‚úÖ Clear Log (Admin Only)
  clearLogBtn.addEventListener('click', async () => {
    const pass = prompt("Enter admin password to clear log:");
    if (pass !== adminPassword) return alert("‚ùå Wrong password!");
    if (confirm("Are you sure you want to clear all logs?")) {
      await remove(changeLogRef);
      alert("‚úÖ Change log cleared!");
    }
  });

  // ‚úÖ Expense CRUD
  onChildAdded(expensesRef, snap => { expenses[snap.key] = snap.val(); renderExpenses(); });
  onChildChanged(expensesRef, snap => { expenses[snap.key] = snap.val(); renderExpenses(); });
  onChildRemoved(expensesRef, snap => { delete expenses[snap.key]; renderExpenses(); });

  onValue(changeLogRef, snap => {
    const data = snap.val();
    changeLog = data ? Object.values(data) : [];
    renderChangeLog();
  });

  expenseForm.addEventListener('submit', async e => {
    e.preventDefault();
    const payer = document.getElementById('payer').value;
    const description = document.getElementById('description').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    if (!payer || !description || isNaN(amount) || amount <= 0) return alert("Invalid input");

    const newRef = push(expensesRef);
    await set(newRef, { payer, description, amount });
    const logRef = push(changeLogRef);
    await set(logRef, { action: 'Added', detail: `${payer} added "${description}" ‚Çπ${amount}`, time: new Date().toLocaleString() });
    expenseForm.reset();
  });

  window.editExpense = async id => {
    const exp = expenses[id];
    const desc = prompt("Edit Description:", exp.description);
    if (desc === null) return;
    const amt = prompt("Edit Amount (‚Çπ):", exp.amount);
    const num = parseFloat(amt);
    if (!desc.trim() || isNaN(num) || num <= 0) return alert("Invalid input");
    await update(ref(database, 'expenses/' + id), { description: desc.trim(), amount: num });
    const logRef = push(changeLogRef);
    await set(logRef, { action: 'Edited', detail: `${exp.payer} updated to "${desc}" ‚Çπ${num}`, time: new Date().toLocaleString() });
  };

  window.deleteExpense = async id => {
    if (!confirm("Delete this expense?")) return;
    const exp = expenses[id];
    await remove(ref(database, 'expenses/' + id));
    const logRef = push(changeLogRef);
    await set(logRef, { action: 'Deleted', detail: `${exp.payer} deleted "${exp.description}" ‚Çπ${exp.amount}`, time: new Date().toLocaleString() });
  };

  function renderExpenses() {
    expenseTableBody.innerHTML = '';
    Object.entries(expenses).forEach(([id, exp]) => {
      const amt = Number(exp.amount) || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${exp.payer}</td>
        <td>${exp.description}</td>
        <td>‚Çπ${amt.toFixed(2)}</td>
        <td>
          <button onclick="editExpense('${id}')">Edit</button>
          <button onclick="deleteExpense('${id}')" style="background:#d9534f;">Delete</button>
        </td>`;
      expenseTableBody.appendChild(tr);
    });
    renderSummary();
  }

  function renderSummary() {
    const list = Object.values(expenses);
    const total = list.reduce((s, e) => s + (Number(e.amount) || 0), 0);
    const share = total / students.length;
    let spent = {};
    students.forEach(s => spent[s] = 0);
    list.forEach(e => spent[e.payer] += e.amount);

    let html = `<p><b>Total:</b> ‚Çπ${total.toFixed(2)} | <b>Share:</b> ‚Çπ${share.toFixed(2)}</p>`;
    html += `<table border="1" width="100%" style="border-collapse:collapse;"><tr><th>Student</th><th>Spent</th><th>Balance</th></tr>`;
    students.forEach(s => {
      const bal = spent[s] - share;
      html += `<tr><td>${s}</td><td>‚Çπ${spent[s].toFixed(2)}</td><td style="color:${bal>=0?'green':'red'};">‚Çπ${bal.toFixed(2)}</td></tr>`;
    });
    html += '</table>';
    summaryContent.innerHTML = html;
  }

  function renderChangeLog() {
    if (changeLog.length === 0) {
      logEntries.innerHTML = `<tr><td colspan="2" style="text-align:center;">No changes yet.</td></tr>`;
      return;
    }
    let rows = '';
    students.forEach(s => {
      const logs = changeLog.filter(l => l.detail.includes(s));
      rows += `<tr><td>${s}</td><td>`;
      if (logs.length === 0) rows += '<em>No changes</em>';
      else logs.forEach(l => rows += `<div class="log-entry">${l.time} - <b>${l.action}</b>: ${l.detail}</div>`);
      rows += '</td></tr>';
    });
    logEntries.innerHTML = rows;
  }
</script>
</body>
</html>
